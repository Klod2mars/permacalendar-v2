mission_id: "M001"
title: "Ajout AppSettings + Provider et dépendances tests"
description: |
  - Créer le modèle AppSettings (lib/core/models/app_settings.dart)
  - Créer le provider AppSettings (lib/core/providers/app_settings_provider.dart)
  - Ajouter dépendances de test utiles (hooks_riverpod, hive_test)
  - Harmoniser imports tests/remnants: remplacer 'package:permacalendarv2' par 'package:permacalendar'
priority: high
max_files: 5
max_lines: 1000
files:
  - path: "lib/core/models/app_settings.dart"
    action: create
    encoding: text
    content: |
      // lib/core/models/app_settings.dart
      import 'package:flutter/material.dart';
      
      /// Modèle AppSettings simple, mutable et compatible avec les tests.
      class AppSettings {
        // champs (mutables)
        String themeMode;
        bool showAnimations;
        String? selectedCommune;
        bool notificationsEnabled;
        double alertThreshold;
        String temperatureUnit;
        double? weatherRadius;
        bool isRuralMode;
        double? lastLatitude;
        double? lastLongitude;
        int analysisIntervalMinutes;
        bool backupEnabled;
        bool gardenCalibrationEnabled;
      
        AppSettings({
          required this.themeMode,
          required this.showAnimations,
          this.selectedCommune,
          required this.notificationsEnabled,
          required this.alertThreshold,
          required this.temperatureUnit,
          this.weatherRadius,
          required this.isRuralMode,
          this.lastLatitude,
          this.lastLongitude,
          required this.analysisIntervalMinutes,
          required this.backupEnabled,
          required this.gardenCalibrationEnabled,
        });
      
        /// Valeurs par défaut attendues par les tests
        factory AppSettings.defaults() => AppSettings(
              themeMode: 'system',
              showAnimations: true,
              selectedCommune: null,
              notificationsEnabled: true,
              alertThreshold: 0.7,
              temperatureUnit: 'celsius',
              weatherRadius: null,
              isRuralMode: false,
              lastLatitude: null,
              lastLongitude: null,
              analysisIntervalMinutes: 60,
              backupEnabled: false,
              gardenCalibrationEnabled: false,
            );
      
        // Sentinel pour distinguer "pas passé" de "valeur null passée explicitement"
        static const _sentinel = Object();
      
        /// copyWith capable d'accepter explicitement null pour les champs optionnels
        AppSettings copyWith({
          Object? themeMode = _sentinel,
          Object? showAnimations = _sentinel,
          Object? selectedCommune = _sentinel,
          Object? notificationsEnabled = _sentinel,
          Object? alertThreshold = _sentinel,
          Object? temperatureUnit = _sentinel,
          Object? weatherRadius = _sentinel,
          Object? isRuralMode = _sentinel,
          Object? lastLatitude = _sentinel,
          Object? lastLongitude = _sentinel,
          Object? analysisIntervalMinutes = _sentinel,
          Object? backupEnabled = _sentinel,
          Object? gardenCalibrationEnabled = _sentinel,
        }) {
          return AppSettings(
            themeMode: themeMode == _sentinel ? this.themeMode : (themeMode as String),
            showAnimations:
                showAnimations == _sentinel ? this.showAnimations : (showAnimations as bool),
            selectedCommune:
                selectedCommune == _sentinel ? this.selectedCommune : (selectedCommune as String?),
            notificationsEnabled: notificationsEnabled == _sentinel
                ? this.notificationsEnabled
                : (notificationsEnabled as bool),
            alertThreshold:
                alertThreshold == _sentinel ? this.alertThreshold : (alertThreshold as double),
            temperatureUnit:
                temperatureUnit == _sentinel ? this.temperatureUnit : (temperatureUnit as String),
            weatherRadius:
                weatherRadius == _sentinel ? this.weatherRadius : (weatherRadius as double?),
            isRuralMode:
                isRuralMode == _sentinel ? this.isRuralMode : (isRuralMode as bool),
            lastLatitude:
                lastLatitude == _sentinel ? this.lastLatitude : (lastLatitude as double?),
            lastLongitude:
                lastLongitude == _sentinel ? this.lastLongitude : (lastLongitude as double?),
            analysisIntervalMinutes: analysisIntervalMinutes == _sentinel
                ? this.analysisIntervalMinutes
                : (analysisIntervalMinutes as int),
            backupEnabled:
                backupEnabled == _sentinel ? this.backupEnabled : (backupEnabled as bool),
            gardenCalibrationEnabled: gardenCalibrationEnabled == _sentinel
                ? this.gardenCalibrationEnabled
                : (gardenCalibrationEnabled as bool),
          );
        }
      
        /// convertit la string en ThemeMode
        ThemeMode get themeModeEnum {
          switch (themeMode) {
            case 'light':
              return ThemeMode.light;
            case 'dark':
              return ThemeMode.dark;
            case 'system':
            default:
              return ThemeMode.system;
          }
        }
      
        /// méthode mutatrice simple (attendue par certains tests)
        void setThemeModeEnum(ThemeMode mode) {
          themeMode = mode == ThemeMode.light
              ? 'light'
              : mode == ThemeMode.dark
                  ? 'dark'
                  : 'system';
        }
      
        @override
        String toString() {
          return 'AppSettings(themeMode: $themeMode, showAnimations: $showAnimations, selectedCommune: $selectedCommune, notificationsEnabled: $notificationsEnabled, alertThreshold: $alertThreshold, temperatureUnit: $temperatureUnit, weatherRadius: $weatherRadius, isRuralMode: $isRuralMode, lastLatitude: $lastLatitude, lastLongitude: $lastLongitude, analysisIntervalMinutes: $analysisIntervalMinutes, backupEnabled: $backupEnabled, gardenCalibrationEnabled: $gardenCalibrationEnabled)';
        }
      }
  - path: "lib/core/providers/app_settings_provider.dart"
    action: create
    encoding: text
    content: |
      // lib/core/providers/app_settings_provider.dart
      import 'package:flutter/material.dart';
      import 'package:riverpod/riverpod.dart';
      import '../models/app_settings.dart';
      
      class AppSettingsNotifier extends Notifier<AppSettings> {
        @override
        AppSettings build() {
          return AppSettings.defaults();
        }
      
        /// Met à jour les dernières coordonnées
        Future<void> setLastCoordinates(double lat, double lon) async {
          state = state.copyWith(lastLatitude: lat, lastLongitude: lon);
        }
      
        /// Définit le theme à partir d'un ThemeMode
        Future<void> setThemeModeEnum(ThemeMode mode) async {
          final tm = mode == ThemeMode.light
              ? 'light'
              : mode == ThemeMode.dark
                  ? 'dark'
                  : 'system';
          state = state.copyWith(themeMode: tm);
        }
      
        Future<void> setSelectedCommune(String? commune) async {
          state = state.copyWith(selectedCommune: commune);
        }
      
        // Ajoute d'autres helpers si besoin
      }
      
      final appSettingsProvider =
          NotifierProvider<AppSettingsNotifier, AppSettings>(() => AppSettingsNotifier());
  - path: ".scripts/replace_package_imports.sh"
    action: create
    encoding: text
    content: |
      #!/usr/bin/env bash
      # usage: ./replace_package_imports.sh
      set -e
      echo "Replacing package:permacalendarv2 -> package:permacalendar in all .dart files..."
      git ls-files '*.dart' | xargs sed -i.bak 's/package:permacalendarv2/package:permacalendar/g' || true
      # remove backups
      git ls-files '*.bak' | xargs rm -f || true
      echo "Done."
commands:
  - "chmod +x .scripts/replace_package_imports.sh || true"
  - "./.scripts/replace_package_imports.sh"
  - |
    # Modify pubspec.yaml: add hooks_riverpod to dependencies and hive_test to dev_dependencies
    # PowerShell and sed commands are both provided; Cursor choisira selon OS.
  - "bash -lc \"awk 'BEGIN{ins=0} /dependencies:/ && !ins{print; print \"  hooks_riverpod: ^3.0.3\"; ins=1; next} {print}' pubspec.yaml > pubspec.yaml.tmp && mv pubspec.yaml.tmp pubspec.yaml\" || true"
  - "bash -lc \"awk 'BEGIN{ins=0} /dev_dependencies:/ && !ins{print; print \"  hive_test: ^1.0.0\"; ins=1; next} {print}' pubspec.yaml > pubspec.yaml.tmp && mv pubspec.yaml.tmp pubspec.yaml\" || true"
  - "flutter pub get"
  - "flutter pub run build_runner build --delete-conflicting-outputs || true"
tests:
  - command: "flutter test"
    expect: "no_missing_files"   # au minimum, plus aucune erreur 'Error when reading ... app_settings.dart'
commit:
  message: "feat(core): add AppSettings model + provider; add test deps; normalize package imports"
  files:
    - "lib/core/models/app_settings.dart"
    - "lib/core/providers/app_settings_provider.dart"
    - ".scripts/replace_package_imports.sh"
    - "pubspec.yaml"
artifacts_to_return:
  - "output_flutter_test"   # le stdout complet de `flutter test`
  - "git_status"            # sortie `git status --porcelain --untracked-files=no`
  - "git_rev"               # sortie `git rev-parse HEAD`
notes: |
  - Avant toute modification majeure de Hive/migration, effectuer backup du dossier de données local.
  - Si 'flutter pub get' échoue à cause de versions, ajuster les versions en cohérence avec le reste du pubspec.
  - Si le repo est Windows-only, exécuter l'équivalent PowerShell pour remplacer les imports (script .scripts fourni est bash).
