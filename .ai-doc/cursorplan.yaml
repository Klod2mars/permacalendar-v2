cursorplan:
  name: "Régulation Vivante – A41 : Zones TAP Silencieuses"
  goal: "Rétablir l’affichage et l’interactivité des zones calibrables (TAP) dans le mode Calibration Organique du Dashboard."
  context:
    audit_reference: "audit-zones-A41.md"
    base_branch: "feature/calibration-organic-unified"
    architecture: "Flutter Clean Architecture (Riverpod + SharedPreferences)"
    focus: "interface de calibration (_buildUnifiedCalibrationInterface)"
  estimated_duration: "2h à 3h (corrigé et testé)"

  phases:

    - id: 1
      name: "Ajout de la méthode _buildCalibrationZones"
      objective: "Créer une méthode dédiée pour afficher les zones OrganicCalibratableZone dans le mode calibration."
      files_modified:
        - "lib/shared/presentation/screens/organic_dashboard_screen.dart"
      actions:
        - "Définir _buildCalibrationZones(BoxConstraints constraints)"
        - "Lire les zones via ref.watch(organicZonesProvider)"
        - "Pour chaque zone, créer un OrganicCalibratableZone visible et draggable"
        - "Encapsuler le tout dans un Stack intégré dans _buildUnifiedCalibrationInterface"
      structure:
        - "Stack"
        - "→ Existing: titre + boutons"
        - "→ New: _buildCalibrationZones(constraints)"
      validations:
        - "Activer le mode calibration"
        - "Vérifier présence visuelle des zones calibrables"
        - "Confirmer que leur position correspond aux valeurs stockées"

    - id: 2
      name: "Implémentation du Drag & Resize interactif"
      objective: "Permettre aux zones calibrables d’être déplacées et redimensionnées pendant le mode calibration."
      files_modified:
        - "lib/shared/widgets/organic_calibratable_zone.dart"
      options:
        - "Option 1: Ajouter paramètres onDragStart, onDragUpdate, onDragEnd"
        - "Option 2: Créer un widget DraggableOrganicZone (wrapper GestureDetector)"
      handlers:
        - "onPanUpdate → provider.setPosition(zoneId, newPosition)"
        - "onPanEnd → calibrationState.markAsModified()"
      validations:
        - "Déplacer une zone → position changée dans provider"
        - "Bouton Valider devient actif"

    - id: 3
      name: "Activation du bouton Valider"
      objective: "S’assurer que la validation s’active uniquement après modification d’une zone."
      files_modified:
        - "lib/shared/presentation/screens/organic_dashboard_screen.dart"
      checks:
        - "Condition actuelle: calibrationState.hasUnsavedChanges"
        - "S’assurer que markAsModified() est invoqué dans onDragUpdate/onDragEnd"
      validations:
        - "Déplacer une zone → bouton actif"
        - "Cliquer sur Valider → saveAll() exécuté"
        - "Reload → positions persistantes"

    - id: 4
      name: "Ajout de logs de debug"
      objective: "Tracer le flux de données entre provider, UI et interactions de calibration."
      files_modified:
        - "lib/core/providers/organic_zones_provider.dart"
        - "lib/shared/presentation/screens/organic_dashboard_screen.dart"
      actions:
        - "Ajouter debugPrint('CALIBRATION: ${zones.length} zones chargées')"
        - "Ajouter debugPrint('DISPLAY: Zones affichées en calibration ${ids}')"
      validations:
        - "Logs visibles dans console lors de l’activation calibration"

  persistence_and_safety:
    - "Aucune suppression de code existant"
    - "Ne pas modifier SharedPreferences ni clés Hive"
    - "Respect strict du Sanctuaire Hive"
    - "Commit après chaque phase (git commit -am 'A41-phaseX')"

  expected_result:
    ui:
      visible_zones: true
      draggable: true
      validation_active: true
    data_flow:
      provider_to_widget: "actif"
      persistence: "confirmée"
    metrics:
      bugs_remaining: 0
      tests_required: 2 (display, drag/persist)
    status_after_execution: "Zones TAP visibles, interactives et persistantes."

  triangle:
    pré_humain:
      role: "Traducteur du rapport en plan exécutable"
      action: "Transmet le sens, préserve la cohérence"
    claude_code:
      role: "Auditeur"
      reference: "Audit A41 – Zones TAP Silencieuses"
      status: "✅ Terminé"
    cursor:
      role: "Exécuteur local"
      action: "Implémente les 4 phases, valide le flux complet sans refonte"
