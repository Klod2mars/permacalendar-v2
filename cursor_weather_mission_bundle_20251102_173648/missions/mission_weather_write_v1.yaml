schema_version: 1.1

mission:
  id: "WRITE-WEATHER-20251102_173648"
  intent: "write_changes"
  scope: "permacalendar_v2_weather"
  # IMPORTANT: replace this with your local absolute path before running with Cursor
  workspace_root: "<ABSOLUTE_PATH_TO_REPO>"
  guardrails:
    sanctuary_excludes: ["data/sanctuary_hive/"]
    allowlist:
      - "lib/"
      - "test/"
      - "config/"
      - "scripts/"
      - "reports/"
      - ".github/workflows/"
    max_lines_changed: 1500
    max_files_changed: 120
    blocked_patterns: ["*sanctuary_hive*", "*.key", "*.keystore", "*.pem"]
    dry_run: true
  tasks:
    - name: create_feature_flag_off
      type: write
      params:
        path: "config/feature_flags.dart"
        content_from: "templates/config/feature_flags.dart"
    - name: add_null_remote_datasource
      type: write
      params:
        path: "lib/weather/data/null_weather_remote_datasource.dart"
        content_from: "templates/lib/weather/data/null_weather_remote_datasource.dart"
    - name: add_open_meteo_service
      type: write
      params:
        path: "lib/weather/open_meteo_service.dart"
        content_from: "templates/lib/weather/open_meteo_service.dart"
    - name: add_local_cache_hive
      type: write
      params:
        path: "lib/weather/local/hive_cache.dart"
        content_from: "templates/lib/weather/local/hive_cache.dart"
    - name: add_repo_interface
      type: write
      params:
        path: "lib/weather/data/weather_repository.dart"
        content_from: "templates/lib/weather/data/weather_repository.dart"
    - name: add_repo_impl
      type: write
      params:
        path: "lib/weather/infrastructure/weather_repository_impl.dart"
        content_from: "templates/lib/weather/infrastructure/weather_repository_impl.dart"
    - name: add_providers_riverpod
      type: write
      params:
        path: "lib/weather/providers/weather_providers.dart"
        content_from: "templates/lib/weather/providers/weather_providers.dart"
    - name: add_ui_widget
      type: write
      params:
        path: "lib/weather/ui/weather_widget.dart"
        content_from: "templates/lib/weather/ui/weather_widget.dart"
    - name: add_backup_and_purge_helpers
      type: write
      params:
        path: "lib/weather/local/hive_backup.dart"
        content_from: "templates/lib/weather/local/hive_backup.dart"
    - name: add_tests_open_meteo
      type: write
      params:
        path: "test/weather/open_meteo_service_test.dart"
        content_from: "templates/test/weather/open_meteo_service_test.dart"
    - name: add_ci_block_old_endpoints
      type: write
      params:
        path: ".github/workflows/weather_endpoint_guard.yml"
        content_from: "templates/.github/workflows/weather_endpoint_guard.yml"
    - name: add_passation_doc
      type: write
      params:
        path: "PASSATION_METEO.md"
        content_from: "templates/PASSATION_METEO.md"
    - name: add_audit_scripts_bash
      type: write
      params:
        path: "scripts/audit_weather.sh"
        content_from: "templates/scripts/audit_weather.sh"
        executable: true
    - name: add_audit_scripts_powershell
      type: write
      params:
        path: "scripts/audit_weather.ps1"
        content_from: "templates/scripts/audit_weather.ps1"
        executable: true
    - name: switch_datasource_to_null_TODO
      type: write
      params:
        path: "reports/weather_audit/TODO_switch_to_null.md"
        content: |
          # TODO (Cursor)
          Re-wire the WeatherRepository implementation to use NullWeatherRemoteDatasource
          until Open-Meteo is validated. Keep feature flag `weatherV2Enabled` = false.
          Ensure quick rollback by reverting this patch only.
  outputs:
    change_report: "reports/change_report.md"
    patches_dir: "reports/patches/"
