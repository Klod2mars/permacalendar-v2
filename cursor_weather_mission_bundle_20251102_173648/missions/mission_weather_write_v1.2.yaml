schema_version: 1.1

mission:
  id: "WRITE-WEATHER-PERSISTENCE-2025-11-02-002"
  intent: "fix_hive_box_conflict_and_defaults"
  scope: "permacalendar_v2_weather"
  workspace_root: "<ABSOLUTE_PATH_TO_REPO>"

  guardrails:
    sanctuary_excludes: ["data/sanctuary_hive/"]
    allowlist:
      - "lib/core/models/"
      - "lib/core/repositories/"
      - "lib/features/climate/data/"
      - "lib/features/climate/presentation/providers/"
      - "lib/"
      - "scripts/"
    dry_run: true
    max_lines_changed: 500
    max_files_changed: 25
    blocked_patterns: ["*sanctuary_hive*", "*.key", "*.pem", "*.keystore"]

  tasks:

    # 1Ô∏è‚É£ Corriger la classe AppSettings avec valeurs par d√©faut
    - name: update_app_settings_defaults
      type: patch
      intent: "add_default_values_to_appsettings"
      params:
        path: "lib/core/models/app_settings.dart"
        search_pattern: "@HiveType"
        inject_before: |
          // ‚úÖ Patch v1.2 ‚Äî valeurs par d√©faut pour √©viter Null-as-bool
          // Si un champ Hive est manquant, Hive utilisera ces valeurs par d√©faut.
          // √âvite l'erreur : type 'Null' is not a subtype of type 'bool' in type cast.
          @HiveType(typeId: 0)
          class AppSettings extends HiveObject {
            @HiveField(0)
            bool darkMode;

            @HiveField(1)
            bool notificationsEnabled;

            @HiveField(2)
            bool firstLaunchDone;

            @HiveField(3)
            String? lastCommune;

            @HiveField(4)
            double? lastLat;

            @HiveField(5)
            double? lastLon;

            AppSettings({
              this.darkMode = false,
              this.notificationsEnabled = true,
              this.firstLaunchDone = true,
              this.lastCommune,
              this.lastLat,
              this.lastLon,
            });
          }

    # 2Ô∏è‚É£ Cr√©er un box s√©par√© pour la persistance m√©t√©o
    - name: replace_commune_storage_box
      type: write
      intent: "use_dedicated_weather_box"
      params:
        path: "lib/features/climate/data/commune_storage.dart"
        content: |
          import 'package:hive/hive.dart';

          // ‚úÖ Patch v1.2 ‚Äî s√©paration du box m√©t√©o
          // Utilise un box distinct pour √©viter tout conflit avec AppSettings.
          class CommuneStorage {
            static const String _boxName = 'weather_settings';
            static const String _keyCommune = 'selected_commune';
            static const String _keyLat = 'selected_lat';
            static const String _keyLon = 'selected_lon';

            static Future<void> saveCommune(String commune, double lat, double lon) async {
              final box = await Hive.openBox(_boxName);
              await box.put(_keyCommune, commune);
              await box.put(_keyLat, lat);
              await box.put(_keyLon, lon);
              await box.close();
            }

            static Future<(String?, double?, double?)> loadCommune() async {
              final box = await Hive.openBox(_boxName);
              final commune = box.get(_keyCommune) as String?;
              final lat = box.get(_keyLat) as double?;
              final lon = box.get(_keyLon) as double?;
              await box.close();
              return (commune, lat, lon);
            }

            static Future<void> clear() async {
              final box = await Hive.openBox(_boxName);
              await box.clear();
              await box.close();
            }
          }

    # 3Ô∏è‚É£ Adapter les providers m√©t√©o pour lire depuis le nouveau box
    - name: patch_weather_providers_for_commune_storage
      type: patch
      intent: "persist_and_load_commune_with_new_box"
      params:
        path: "lib/features/climate/presentation/providers/weather_providers.dart"
        search_pattern: "selectedCommuneCoordinatesProvider"
        inject_after: |
          // ‚úÖ Patch v1.2 ‚Äî ajout provider persistant via CommuneStorage
          import 'package:permacalendar/features/climate/data/commune_storage.dart';

          final persistedCoordinatesProvider = FutureProvider<Coordinates?>((ref) async {
            final (commune, lat, lon) = await CommuneStorage.loadCommune();
            if (commune == null || lat == null || lon == null) return null;
            return Coordinates(lat, lon);
          });

    # 4Ô∏è‚É£ Script pour purger l‚Äôancien settingsBox corrompu
    - name: create_clear_old_settings_script
      type: write
      intent: "clear_legacy_settings_box"
      params:
        path: "scripts/clear_old_hive_settings.dart"
        content: |
          // ‚úÖ Patch v1.2 ‚Äî purge du box Hive corrompu avant relance
          import 'package:hive/hive.dart';

          Future<void> main() async {
            print('üßπ Purge de l‚Äôancien box Hive (settings)...');
            final box = await Hive.openBox('settings');
            await box.clear();
            await box.close();
            print('‚úÖ Box "settings" vid√© avec succ√®s.');
          }

  outputs:
    change_report: "reports/weather_persistence_v1.2_change_report.md"
    patches_dir: "reports/patches/weather_v1.2/"
