name: Flutter Tests & Coverage

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    name: Run Tests with Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x' # Ajuster selon votre version
          channel: 'stable'
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Verify formatting
        run: dart format --set-exit-if-changed .
        continue-on-error: true # Ne pas bloquer le build sur le formatage
      
      - name: Analyze code
        run: flutter analyze
        continue-on-error: true # Ne pas bloquer le build sur l'analyse
      
      - name: Run all tests
        run: flutter test --reporter=expanded
      
      - name: Run tests with coverage
        run: flutter test --coverage
      
      - name: Check test coverage
        run: |
          # Install lcov for coverage reporting
          sudo apt-get update
          sudo apt-get install -y lcov
          
          # Generate coverage summary
          lcov --summary coverage/lcov.info
          
          # Extract coverage percentage for domain layer
          DOMAIN_COVERAGE=$(lcov --list coverage/lcov.info | grep 'lib/features/plant_intelligence/domain' | awk '{print $2}' | sed 's/%//' | awk '{sum+=$1; count++} END {if (count>0) print sum/count; else print 0}')
          echo "Domain layer coverage: ${DOMAIN_COVERAGE}%"
          
          # Check if coverage meets threshold (80%)
          if (( $(echo "$DOMAIN_COVERAGE < 80" | bc -l) )); then
            echo "âŒ Coverage below 80% threshold (${DOMAIN_COVERAGE}%)"
            exit 1
          else
            echo "âœ… Coverage meets 80% threshold (${DOMAIN_COVERAGE}%)"
          fi
      
      - name: Upload coverage to Codecov (optional)
        uses: codecov/codecov-action@v3
        if: success()
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          verbose: true
      
      - name: Generate HTML coverage report
        if: always()
        run: |
          genhtml coverage/lcov.info -o coverage/html
      
      - name: Upload coverage report artifact
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: coverage/html

  integration-tests:
    name: Run Integration Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.x'
          channel: 'stable'
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Run integration tests
        run: flutter test test/integration/ --reporter=expanded
        continue-on-error: true # Les tests d'intÃ©gration peuvent Ã©chouer si structure incomplÃ¨te
      
      - name: Run Modern Adapter tests
        run: flutter test test/core/services/aggregation/modern_data_adapter_test.dart --reporter=expanded
      
      - name: Run Aggregation Hub tests
        run: flutter test test/core/services/aggregation/garden_aggregation_hub_test.dart --reporter=expanded

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test, integration-tests]
    if: always()
    
    steps:
      - name: Test Results Summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Unit Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Integration Tests: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Coverage report available in artifacts" >> $GITHUB_STEP_SUMMARY

