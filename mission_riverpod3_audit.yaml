meta:
  name: "Riverpod 3 Deep Audit & Comparison"
  description: >
    Vérifier la validité du précédent audit Riverpod 3 et croiser les conclusions entre
    l’analyse humaine (Jean Tintin), GPT5 et Cursor.
    L’objectif est de déterminer les causes exactes du crash et de confirmer ou réfuter
    les hypothèses de dépendance inversée et d’incohérences Riverpod 3.

objectives:
  - Scanner le dépôt complet `permacalendar-v2` (branche main)
  - Identifier la source des erreurs de compilation (types/providers manquants)
  - Comparer les constats du rapport précédent avec la réalité du code
  - Vérifier la conformité Clean Architecture (domain / core / presentation)
  - Établir un plan de correction précis, ordonné et minimal

context:
  project: "PermaCalendar"
  tech_stack:
    flutter: ">=3.22"
    dart: ">=3.9"
    riverpod: "3.x"
  known_issues:
    - "core/services/intelligence_auto_notifier.dart importe des providers presentation"
    - "Mix flutter_riverpod / riverpod"
    - "Providers globaux (intelligentAlerts, contextualRecommendations...) au mauvais niveau"
  comparison_sources:
    - "Audit de Jean Tintin (rapport textuel fourni)"
    - "Audit GPT5 (analyse conceptuelle)"
    - "Audit Cursor (analyse directe du dépôt indexé)"

tasks:
  - id: scan_repo_structure
    description: >
      Cartographier la structure du projet et vérifier les relations entre couches :
      - Domain : entities, usecases
      - Core : services, di, providers
      - Presentation : providers, screens, widgets
    expected_output: "Diagramme et table des dépendances inter-couches"

  - id: detect_provider_inversions
    description: >
      Lister tous les fichiers qui importent `presentation/providers/*` depuis `core` ou `domain`.
      Identifier les dépendances inversées (core → presentation).
    commands:
      - grep -R "presentation/providers" lib/core
      - grep -R "presentation/providers" lib/features
    expected_output: "Liste des imports fautifs avec ligne et fichier précis"

  - id: analyze_riverpod_imports
    description: >
      Rechercher les fichiers utilisant `package:riverpod/riverpod.dart` et
      `package:flutter_riverpod/flutter_riverpod.dart` pour détecter les mélanges incohérents.
    commands:
      - grep -R "package:riverpod" lib/
      - grep -R "package:flutter_riverpod" lib/
    expected_output: "Tableau comparatif des fichiers et du type d'import"

  - id: confirm_audit_claims
    description: >
      Vérifier les affirmations de l’audit :
      - providers dupliqués (ex: intelligentAlertsProvider)
      - inversion core→presentation
      - présence de intelligenceStateProvider et références valides
    expected_output: "Pour chaque affirmation, statut: confirmé / infirmé / partiel"

  - id: generate_correction_plan
    description: >
      Si les constats sont confirmés :
      - Générer automatiquement un patch minimal (git diff simulé)
        pour :
        - créer core/providers/intelligence_runtime_providers.dart
        - ajuster les imports dans intelligence_auto_notifier.dart
        - aliaser les providers UI vers ceux du core
      - Sinon : proposer un correctif alternatif.
    expected_output: "Patchs textuels et étapes à exécuter"

deliverables:
  - "Rapport comparatif (Jean Tintin / GPT5 / Cursor)"
  - "Table des dépendances croisées"
  - "Liste des incohérences de providers"
  - "Patchs applicables (diff format)"
  - "Synthèse finale : qui a raison ? qui a tort ?"
