meta:
  project_name: IAMcoder
  description: "Template: applywrites dry-run -> check -> live"
  version: "1.0"

context:
  mode: write_enabled

tasks:
  - name: apply_writes_dry_run
    goal: "Dry-run: simulate file writes"
    task_type: task_apply_writes
    parameters:
      instructions:
        writes:
          - file: "lib/shared/utils/plant_image_resolver.dart"
            content: |
              // lib/shared/utils/plant_image_resolver.dart
              import 'dart:convert';
              import 'package:flutter/services.dart';

              /// Résolveur d'asset d'image pour une "plant" (tolérant casse / extension / dossiers).
              /// Accepts a dynamic `plant` (objet provenant du catalogue : doit exposer
              /// `id`, `commonName`, `metadata`).
              Future<String?> findPlantImageAsset(dynamic plant) async {
                try {
                  // 1) Charger manifest et table lowercase -> original
                  final manifest = await rootBundle.loadString('AssetManifest.json');
                  final Map<String, dynamic> m = json.decode(manifest);
                  final mapLower = <String, String>{};
                  for (final k in m.keys) {
                    mapLower[k.toLowerCase()] = k;
                  }

                  // 2) extraire valeur metadata si présente
                  String? raw;
                  try {
                    final meta = (plant?.metadata);
                    if (meta != null && meta is Map) {
                      raw = meta['image'] ??
                            meta['imagePath'] ??
                            meta['photo'] ??
                            meta['image_url'] ??
                            meta['imageUrl'];
                      if (raw is String) raw = raw.trim();
                    }
                  } catch (_) {}

                  // 3) construire candidats
                  final candidates = <String>[];
                  if (raw != null && raw.isNotEmpty) {
                    final base = raw;
                    // si l'utilisateur a mis un chemin assets/ explicite
                    if (base.startsWith('assets/')) {
                      candidates.add(base);
                      candidates.add(base.toLowerCase());
                    } else {
                      candidates.add('assets/images/legumes/$base');
                      candidates.add('assets/images/legumes/${base.toLowerCase()}');
                      candidates.add('assets/images/plants/$base');
                      candidates.add('assets/images/plants/${base.toLowerCase()}');
                      candidates.add('assets/$base');
                      candidates.add('assets/${base.toLowerCase()}');

                      if (!RegExp(r'\\.\w+$').hasMatch(base)) {
                        final exts = ['.png', '.jpg', '.jpeg', '.webp'];
                        for (final ext in exts) {
                          candidates.add('assets/images/legumes/${base}$ext');
                          candidates.add('assets/images/legumes/${base.toLowerCase()}$ext');
                          candidates.add('assets/images/plants/${base}$ext');
                          candidates.add('assets/images/plants/${base.toLowerCase()}$ext');
                        }
                      } else {
                        candidates.add('assets/images/legumes/${base.toLowerCase()}');
                        candidates.add('assets/images/plants/${base.toLowerCase()}');
                      }
                    }
                  }

                  // ajouter candidats id / commonName
                  final id = (plant?.id ?? '').toString();
                  if (id.isNotEmpty) {
                    candidates.add('assets/images/legumes/$id.jpg');
                    candidates.add('assets/images/legumes/$id.png');
                    candidates.add('assets/images/legumes/$id.webp');
                    candidates.add('assets/images/plants/$id.jpg');
                    candidates.add('assets/images/plants/$id.png');
                  }

                  final cn = (plant?.commonName ?? '').toString();
                  if (cn.isNotEmpty) {
                    var safe = cn.toLowerCase().trim();
                    safe = safe.replaceAll(RegExp(r'[^a-z0-9_\\-]'), '_');
                    final exts = ['.png', '.jpg', '.jpeg', '.webp'];
                    for (final ext in exts) {
                      candidates.add('assets/images/legumes/${safe}$ext');
                      candidates.add('assets/images/plants/${safe}$ext');
                    }
                  }

                  // dédupliquer
                  final seen = <String>{};
                  final finalCandidates = <String>[];
                  for (final c in candidates) {
                    if (c != null && c.isNotEmpty && !seen.contains(c)) {
                      seen.add(c);
                      finalCandidates.add(c);
                    }
                  }

                  // 4) recherche via manifest (insensible à la casse)
                  for (final c in finalCandidates) {
                    final lc = c.toLowerCase();
                    if (mapLower.containsKey(lc)) return mapLower[lc];
                  }
                  for (final c in finalCandidates) {
                    final lc = c.toLowerCase();
                    for (final keyLower in mapLower.keys) {
                      if (keyLower.endsWith(lc)) return mapLower[keyLower];
                    }
                  }

                  // 5) dernier recours : essayer rootBundle.load
                  for (final c in finalCandidates) {
                    try {
                      await rootBundle.load(c);
                      return c;
                    } catch (_) {}
                  }
                } catch (_) {}
                return null;
              }
            append: false
            create_backup: true

          - file: "lib/features/garden_bed/presentation/widgets/garden_bed_card.dart"
            content: |
              // lib/features/garden_bed/presentation/widgets/garden_bed_card.dart
              import 'package:flutter/material.dart';
              import 'package:flutter_riverpod/flutter_riverpod.dart';

              import '../../../../shared/widgets/custom_card.dart';
              import '../../../../core/models/garden_bed.dart';
              import '../../../../core/models/planting.dart';
              import '../../../../core/utils/planting_utils.dart';
              import '../../../planting/providers/planting_provider.dart';
              import '../../../plant_catalog/providers/plant_catalog_provider.dart';
              import '../../../../shared/utils/plant_image_resolver.dart';

              class GardenBedCard extends ConsumerWidget {
                final GardenBed gardenBed;
                final VoidCallback? onTap;
                final VoidCallback? onEdit;
                final VoidCallback? onDelete;
                final Widget? extraContent;

                const GardenBedCard({
                  super.key,
                  required this.gardenBed,
                  this.onTap,
                  this.onEdit,
                  this.onDelete,
                  this.extraContent,
                });

                @override
                Widget build(BuildContext context, WidgetRef ref) {
                  final theme = Theme.of(context);

                  // Providers pour réactivité
                  final allPlantings = ref.watch(plantingsListProvider);
                  final plantsCatalog = ref.watch(plantsListProvider);

                  // Trouver la plantation active pour cette parcelle (la plus récente)
                  Planting? activePlanting;
                  for (final p in allPlantings) {
                    if (p.gardenBedId == gardenBed.id && p.isActive) {
                      activePlanting = p;
                      break;
                    }
                  }

                  // Trouver la plante liée dans le catalogue (si présente)
                  dynamic plant;
                  if (activePlanting != null) {
                    for (final pl in plantsCatalog) {
                      if (pl.id == activePlanting.plantId) {
                        plant = pl;
                        break;
                      }
                    }
                  }

                  return CustomCard(
                    child: InkWell(
                      borderRadius: BorderRadius.circular(12),
                      onTap: onTap,
                      child: Padding(
                        padding: const EdgeInsets.all(16),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                // Image (vignette) ou icône - resolved via plant_image_resolver
                                ClipRRect(
                                  borderRadius: BorderRadius.circular(8),
                                  child: FutureBuilder<String?>(
                                    future: findPlantImageAsset(plant),
                                    builder: (ctx, snapshot) {
                                      if (snapshot.connectionState != ConnectionState.done) {
                                        return Container(
                                          width: 64,
                                          height: 64,
                                          color: Colors.green.shade50,
                                          alignment: Alignment.center,
                                          child: const SizedBox(
                                            width: 20,
                                            height: 20,
                                            child: CircularProgressIndicator(strokeWidth: 2),
                                          ),
                                        );
                                      }
                                      final found = snapshot.data;
                                      if (found != null) {
                                        return Image.asset(
                                          found,
                                          width: 64,
                                          height: 64,
                                          fit: BoxFit.cover,
                                          errorBuilder: (_, __, ___) => _buildFallbackImage(context, width: 64, height: 64, fit: BoxFit.cover),
                                        );
                                      } else {
                                        return _buildFallbackImage(context, width: 64, height: 64, fit: BoxFit.cover);
                                      }
                                    },
                                  ),
                                ),
                                const SizedBox(width: 12),
                                // Texte principal + progression si présente
                                Expanded(
                                  child: Column(
                                    crossAxisAlignment: CrossAxisAlignment.start,
                                    children: [
                                      Text(
                                        gardenBed.name,
                                        style: theme.textTheme.titleMedium?.copyWith(
                                          fontWeight: FontWeight.bold,
                                        ),
                                      ),
                                      const SizedBox(height: 4),
                                      Text(
                                        "${gardenBed.sizeInSquareMeters.toStringAsFixed(1)} m²",
                                        style: theme.textTheme.bodySmall?.copyWith(
                                          color: theme.colorScheme.primary,
                                        ),
                                      ),
                                      if (activePlanting != null) ...[
                                        const SizedBox(height: 8),
                                        Text(
                                          "${plant?.commonName ?? plant?.id ?? activePlanting.plantName} — Semé le ${activePlanting.plantedDate.day}/${activePlanting.plantedDate.month}",
                                          style: theme.textTheme.bodySmall,
                                        ),
                                        const SizedBox(height: 6),
                                        Builder(builder: (ctx) {
                                          final progress = computePlantingProgress(activePlanting!);
                                          return Column(
                                            crossAxisAlignment: CrossAxisAlignment.start,
                                            children: [
                                              LinearProgressIndicator(value: progress),
                                              const SizedBox(height: 6),
                                              Text(
                                                '${(progress * 100).toStringAsFixed(0)}% vers début récolte',
                                                style: theme.textTheme.bodySmall?.copyWith(
                                                  color: theme.colorScheme.onSurfaceVariant,
                                                ),
                                              ),
                                            ],
                                          );
                                        }),
                                      ],
                                    ],
                                  ),
                                ),
                                // Bouton récolte (visible quand la plantation existe) :
                                if (activePlanting != null)
                                  _buildHarvestOrEditButton(context, ref, activePlanting),
                                // Menu contextuel
                                PopupMenuButton<String>(
                                  onSelected: (value) {
                                    if (value == 'edit' && onEdit != null) onEdit!();
                                    if (value == 'delete' && onDelete != null) onDelete!();
                                  },
                                  itemBuilder: (context) => [
                                    const PopupMenuItem(
                                        value: 'edit', child: Text('Modifier')),
                                    const PopupMenuItem(
                                      value: 'delete',
                                      child: Text('Supprimer', style: TextStyle(color: Colors.red)),
                                    ),
                                  ],
                                ),
                              ],
                            ),
                            if (extraContent != null) ...[
                              const SizedBox(height: 12),
                              extraContent!,
                            ],
                          ],
                        ),
                      ),
                    ),
                  );
                }

                Widget _buildHarvestOrEditButton(BuildContext context, WidgetRef ref, Planting active) {
                  final theme = Theme.of(context);
                  final progress = computePlantingProgress(active);
                  final bool inHarvestWindow = active.isInHarvestPeriod || progress >= 1.0;

                  if (!inHarvestWindow) {
                    // Afficher le bouton d'édition (existant)
                    return IconButton(
                      icon: const Icon(Icons.local_florist),
                      color: theme.colorScheme.primary,
                      onPressed: onEdit,
                    );
                  }

                  // Afficher bouton récolte (vert) et ouvrir un dialogue pour enregistrer la récolte
                  return IconButton(
                    tooltip: 'Récolter',
                    icon: const Icon(Icons.agriculture),
                    color: Colors.green,
                    onPressed: () => _showQuickHarvestDialog(context, ref, active),
                  );
                }

                void _showQuickHarvestDialog(BuildContext context, WidgetRef ref, Planting planting) {
                  final _quantityController = TextEditingController();
                  final _notesController = TextEditingController();
                  final _formKey = GlobalKey<FormState>();

                  showDialog(
                    context: context,
                    builder: (dctx) => AlertDialog(
                      title: Text('Récolte: ${planting.plantName}'),
                      content: Form(
                        key: _formKey,
                        child: Column(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            TextFormField(
                              controller: _quantityController,
                              keyboardType: const TextInputType.numberWithOptions(decimal: true),
                              decoration: const InputDecoration(labelText: 'Quantité (optionnel)'),
                              validator: (v) {
                                if (v != null && v.trim().isNotEmpty) {
                                  final d = double.tryParse(v.trim().replaceAll(',', '.'));
                                  if (d == null || d < 0) return 'Quantité invalide';
                                }
                                return null;
                              },
                            ),
                            const SizedBox(height: 8),
                            TextFormField(
                              controller: _notesController,
                              decoration: const InputDecoration(labelText: 'Notes (optionnel)'),
                              maxLines: 2,
                            ),
                          ],
                        ),
                      ),
                      actions: [
                        TextButton(onPressed: () => Navigator.of(dctx).pop(), child: const Text('Annuler')),
                        FilledButton(
                          onPressed: () async {
                            if (!_formKey.currentState!.validate()) return;
                            final raw = _quantityController.text.trim();
                            final double? qty = raw.isEmpty ? null : double.tryParse(raw.replaceAll(',', '.'));
                            final notes = _notesController.text.trim().isEmpty ? null : _notesController.text.trim();

                            Navigator.of(dctx).pop();

                            final success = await ref.read(plantingProvider.notifier).recordHarvest(planting.id, DateTime.now(), quantity: qty, notes: notes);

                            if (success && context.mounted) {
                              ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Récolte enregistrée')));
                            } else if (context.mounted) {
                              ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Erreur lors de l\'enregistrement')));
                            }
                          },
                          child: const Text('Enregistrer'),
                        ),
                      ],
                    ),
                  );
                }

                Widget _buildFallbackImage(BuildContext ctx, {double width = 64, double height = 64, BoxFit fit = BoxFit.cover}) {
                  return Image.asset(
                    'assets/images/legumes/default.png',
                    width: width,
                    height: height,
                    fit: fit,
                    errorBuilder: (context, error, stackTrace) {
                      // Ultimate fallback: simple icon so we never throw at runtime
                      return Container(
                        width: width,
                        height: height,
                        color: Colors.grey.shade200,
                        alignment: Alignment.center,
                        child: Icon(Icons.eco, size: (width < height ? width : height) * 0.6, color: Theme.of(context).colorScheme.primary),
                      );
                    },
                  );
                }
            append: false
            create_backup: true
      dry_run: true
      output: "reports/last_report.json"

  - name: check_dry_run_report
    goal: "Ensure dry run reported changes"
    task_type: yaml_check_report
    parameters:
      report_path: "reports/last_report.json"
      expected_status: "dry_run_ok"

  - name: apply_writes_live
    goal: "Apply the writes for real"
    task_type: task_apply_writes
    parameters:
      instructions:
        writes:
          - file: "lib/shared/utils/plant_image_resolver.dart"
            content: |
              # same as in dry-run (identical)
            append: false
            create_backup: true
          - file: "lib/features/garden_bed/presentation/widgets/garden_bed_card.dart"
            content: |
              # same as in dry-run (identical)
            append: false
            create_backup: true
      dry_run: false
      create_backup: true
      create_git_checkpoint: false
